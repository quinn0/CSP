<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Rubric</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General styling for the rubric rows and cells */
        .rubric-row:nth-child(odd) {
            background-color: rgba(243, 244, 246, 0.5);
        }
        
        .rating-cell {
            transition: all 0.2s ease;
            position: relative;
        }
        
        .rating-cell:hover {
            background-color: rgba(209, 213, 219, 0.5);
            cursor: pointer;
        }
        
        .selected {
            background-color: #4f46e5 !important;
            color: white;
            font-weight: 600;
        }
        
        /* Top bar for student name and score */
        .top-bar {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        
        .student-name-field {
            margin-right: 10px;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #4f46e5;
            font-weight: 500;
            width: 200px;
        }
        
        .score-display {
            background-color: #4f46e5;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            font-weight: 600;
        }
        
        /* Styling for expandable feedback and description rows */
        .feedback-row, .description-row, .level-description-row {
            display: none;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .feedback-row.visible, .description-row.visible, .level-description-row.visible {
            display: table-row;
        }

        .level-description-row.visible {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Modal styling for the summary pop-up */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal.visible {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Criteria name styling for info icon */
        .criteria-name {
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .criteria-name:hover {
            color: #4f46e5;
        }
        
        .criteria-name::after {
            content: "â“˜";
            font-size: 0.8rem;
            margin-left: 0.5rem;
            color: #6366f1;
        }
        
        /* Error and success message styling */
        .error-message, .success-message {
            color: #dc2626;
            font-weight: 600;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: right;
        }

        .success-message {
            color: #10B981;
        }
        
        .error-message.visible, .success-message.visible {
            opacity: 1;
        }
        
        /* Animation for highlighting missing selections */
        .highlight-missing {
            animation: pulse 1.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { background-color: rgba(239, 68, 68, 0); }
            50% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: rgba(239, 68, 68, 0); }
        }
        
        /* Animation for the finalized view */
        .finalized-view {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Styling for rating badges in the summary */
        .rating-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }
        
        .rating-1 { background-color: #EF4444; }
        .rating-2 { background-color: #F59E0B; }
        .rating-3 { background-color: #3B82F6; }
        .rating-4 { background-color: #10B981; }
        
        /* Styling for feedback cards in the summary */
        .feedback-card {
            border-left: 4px solid #4f46e5;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen p-4 md:p-8">
    <div id="rubric-container" class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden relative">
        <!-- Student name and score display in top right corner -->
        <div class="top-bar">
            <input type="text" id="student-name" class="student-name-field" placeholder="Student Name" />
            <div class="score-display">
                Score: <span id="corner-score">0</span>/20
            </div>
        </div>
        
        <div class="p-6 bg-indigo-600 text-white">
            <h1 class="text-2xl font-bold">Interactive Rubric</h1>
            <p class="text-indigo-100 mt-1">Click on a cell to select a rating for each criterion</p>
        </div>
        
        <div class="p-6">
            <div class="overflow-x-auto">
                <table id="rubric-table" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-indigo-100 text-indigo-800">
                            <th class="p-4 text-left font-semibold border-b-2 border-indigo-200 w-1/4">Criteria</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 1</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 2</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 3</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 4</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Row 1: Content Knowledge -->
                        <tr class="rubric-row" id="criteria-row-0">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="0">Content Knowledge</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="0">Limited</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="1">Basic</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="2">Proficient</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="3">Advanced</td>
                        </tr>
                        <tr class="description-row" id="description-row-0">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Content Knowledge:</strong> Evaluates the student's understanding and mastery of subject matter. This includes accuracy of information, depth of knowledge, and ability to apply concepts appropriately.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-0">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-0"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-0">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Content Knowledge..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 2: Organization -->
                        <tr class="rubric-row" id="criteria-row-1">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="1">Organization</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="0">Disorganized</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="1">Somewhat Organized</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="2">Well Organized</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="3">Exceptionally Organized</td>
                        </tr>
                        <tr class="description-row" id="description-row-1">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Organization:</strong> Assesses how well the student structures information and ideas. This includes logical sequencing, clear transitions, and coherent arrangement of content to support understanding.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-1">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-1"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-1">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Organization..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 3: Communication -->
                        <tr class="rubric-row" id="criteria-row-2">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="2">Communication</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="0">Unclear</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="1">Somewhat Clear</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="2">Clear</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="3">Exceptionally Clear</td>
                        </tr>
                        <tr class="description-row" id="description-row-2">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Communication:</strong> Evaluates how effectively the student conveys ideas. This includes clarity of expression, appropriate language use, and the ability to articulate concepts in a way that others can understand.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-2">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-2"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-2">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Communication..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 4: Creativity -->
                        <tr class="rubric-row" id="criteria-row-3">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="3">Creativity</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="0">Minimal</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="1">Developing</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="2">Creative</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="3">Highly Creative</td>
                        </tr>
                        <tr class="description-row" id="description-row-3">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Creativity:</strong> Assesses the student's originality and innovative thinking. This includes novel approaches to problems, unique perspectives, and imaginative solutions that go beyond conventional thinking.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-3">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-3"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-3">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Creativity..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 5: Collaboration -->
                        <tr class="rubric-row" id="criteria-row-4">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="4">Collaboration</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="0">Limited</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="1">Adequate</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="2">Effective</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="3">Exceptional</td>
                        </tr>
                        <tr class="description-row" id="description-row-4">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Collaboration:</strong> Evaluates how well the student works with others. This includes active participation in group work, respectful engagement with peers, contribution to shared goals, and ability to incorporate others' perspectives.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-4">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-4"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-4">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Collaboration..."></textarea>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 flex justify-between items-center">
                <div class="text-gray-700">
                    <span class="font-semibold">Total Score:</span> <span id="total-score">0</span> / 20
                </div>
                <div class="flex flex-col items-end">
                    <div class="flex">
                        <!-- Edit and Save Changes buttons added here -->
                        <button id="edit-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-md text-white transition-colors mr-2">Edit</button>
                        <button id="save-changes-btn" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-md text-white transition-colors mr-2 hidden">Save Changes</button>
                        <button id="reset-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors mr-2">Reset</button>
                        <button id="save-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white transition-colors">Save Rubric</button>
                    </div>
                    <div id="error-message" class="error-message"></div>
                    <div id="success-message" class="success-message"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for displaying assessment summary -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-indigo-800 mb-4">Assessment Summary</h2>
            <div class="bg-gray-50 p-4 rounded-md mb-4">
                <div class="mb-2"><strong>Student Name:</strong> <span id="modal-student-name"></span></div>
                <div class="mb-2"><strong>Total Score:</strong> <span id="modal-total-score"></span>/20</div>
                <div class="mt-4 mb-2"><strong>Individual Ratings:</strong></div>
                <ul class="list-disc pl-5 mb-4" id="modal-ratings-list"></ul>
                <div class="mt-4 mb-2"><strong>Feedback Comments:</strong></div>
                <div id="modal-feedback" class="text-sm"></div>
            </div>
            <div class="flex justify-between">
                <button id="finalize-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white transition-colors">Finalize</button>
                <button id="close-modal-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white transition-colors">Close</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get all interactive elements from the DOM
            const ratingCells = document.querySelectorAll('.rating-cell');
            const totalScoreElement = document.getElementById('total-score');
            const cornerScoreElement = document.getElementById('corner-score');
            const resetBtn = document.getElementById('reset-btn');
            const saveBtn = document.getElementById('save-btn');
            const feedbackRows = document.querySelectorAll('.feedback-row');
            const studentNameInput = document.getElementById('student-name');
            const saveModal = document.getElementById('save-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const finalizeBtn = document.getElementById('finalize-btn');
            const criteriaNames = document.querySelectorAll('.criteria-name');
            const errorMessageElement = document.getElementById('error-message');
            const successMessageElement = document.getElementById('success-message');
            const rubricContainer = document.getElementById('rubric-container');
            const rubricTable = document.getElementById('rubric-table');
            const editBtn = document.getElementById('edit-btn');
            const saveChangesBtn = document.getElementById('save-changes-btn');

            // --- Data and State Management ---

            // Track visibility of criteria description rows
            const descriptionVisibility = [false, false, false, false, false];

            // Labels for each criterion
            const criteriaLabels = [
                "Content Knowledge", "Organization", "Communication", "Creativity", "Collaboration"
            ];

            // Labels for each rating level within a criterion
            const ratingLevels = [
                ["Limited", "Basic", "Proficient", "Advanced"],
                ["Disorganized", "Somewhat Organized", "Well Organized", "Exceptionally Organized"],
                ["Unclear", "Somewhat Clear", "Clear", "Exceptionally Clear"],
                ["Minimal", "Developing", "Creative", "Highly Creative"],
                ["Limited", "Adequate", "Effective", "Exceptional"]
            ];

            // Detailed descriptions for each performance level
            const levelDescriptions = [
                [
                    "Demonstrates very limited understanding of the subject matter. Information is often inaccurate or irrelevant.",
                    "Shows basic understanding of core concepts, but may have some inaccuracies or gaps in knowledge.",
                    "Demonstrates a solid understanding of the subject matter, with accurate information and appropriate application of concepts.",
                    "Exhibits deep and comprehensive understanding, connecting concepts and applying knowledge in sophisticated ways."
                ],
                [
                    "Ideas are presented randomly with no clear structure. Difficult to follow the progression of thought.",
                    "Some attempt at organization, but transitions are unclear, and the structure may be difficult to follow at times.",
                    "Ideas are logically sequenced with clear transitions, making the content easy to follow and understand.",
                    "Presents information with exceptional clarity and logical flow, enhancing the overall impact and coherence."
                ],
                [
                    "Communication is consistently unclear or difficult to understand, hindering the message.",
                    "Communication is somewhat clear, but may require effort from the audience to fully grasp the message.",
                    "Effectively conveys ideas with clarity and precision, using appropriate language and style.",
                    "Communicates with exceptional clarity, eloquence, and impact, engaging the audience effectively."
                ],
                [
                    "Lacks originality; ideas are conventional or directly copied. Shows no evidence of innovative thinking.",
                    "Shows some emerging signs of originality, but ideas are mostly conventional. Limited innovative approaches.",
                    "Demonstrates creative thinking through original ideas or unique approaches to problems.",
                    "Consistently generates highly original and innovative ideas, demonstrating exceptional creativity and imaginative solutions."
                ],
                [
                    "Struggles to work with others; may be uncooperative or disengaged in group activities.",
                    "Participates adequately in group work, but contributions may be limited or require prompting.",
                    "Works effectively with peers, contributing actively, respecting diverse perspectives, and supporting group goals.",
                    "Exemplifies outstanding collaboration, inspiring others, fostering a positive group dynamic, and achieving shared goals exceptionally well."
                ]
            ];

            // State arrays to store user input
            let selectedRatings = Array(criteriaLabels.length).fill(null);
            let feedbackTexts = Array(criteriaLabels.length).fill('');

            // --- Core Functions ---

            // Calculate and update the total score display
            function updateScore() {
                const totalScore = selectedRatings.reduce((sum, rating) => {
                    return sum + (rating !== null ? rating + 1 : 0);
                }, 0);
                totalScoreElement.textContent = totalScore;
                cornerScoreElement.textContent = totalScore;
            }

            // Reset the entire rubric to its initial state
            function resetRubric() {
                selectedRatings.fill(null);
                feedbackTexts.fill('');
                updateScore();

                ratingCells.forEach(cell => cell.classList.remove('selected'));
                feedbackRows.forEach(row => {
                    row.classList.remove('visible');
                    row.querySelector('textarea').value = '';
                });
                document.querySelectorAll('.level-description-row, .description-row').forEach((row, index) => {
                    row.classList.remove('visible');
                    if(row.classList.contains('level-description-row')) row.querySelector('p').textContent = '';
                    if(row.classList.contains('description-row')) descriptionVisibility[index % 5] = false;
                });

                studentNameInput.value = '';
                hideMessage(errorMessageElement);
                hideMessage(successMessageElement);
                rubricContainer.classList.remove('finalized-view');
                enableRubricInteraction();
                editBtn.classList.remove('hidden');
                saveChangesBtn.classList.add('hidden');
                setTableEditable(false);
            }

            // Show a temporary message (error or success)
            function showMessage(element, message) {
                element.textContent = message;
                element.classList.add('visible');
                setTimeout(() => hideMessage(element), 5000);
            }

            // Hide a message
            function hideMessage(element) {
                element.classList.remove('visible');
                element.textContent = '';
            }

            // Enable all rubric interactions
            function enableRubricInteraction() {
                ratingCells.forEach(cell => cell.style.pointerEvents = 'auto');
                feedbackRows.forEach(row => row.querySelector('textarea').readOnly = false);
                criteriaNames.forEach(name => name.style.pointerEvents = 'auto');
                studentNameInput.readOnly = false;
                saveBtn.disabled = false;
                resetBtn.disabled = false;
            }

            // Disable all rubric interactions (for finalized or edit mode)
            function disableRubricInteraction() {
                ratingCells.forEach(cell => cell.style.pointerEvents = 'none');
                feedbackRows.forEach(row => row.querySelector('textarea').readOnly = true);
                criteriaNames.forEach(name => name.style.pointerEvents = 'none');
                studentNameInput.readOnly = true;
                saveBtn.disabled = true;
                resetBtn.disabled = true;
            }

            // Make table cells content-editable for rubric customization
            function setTableEditable(isEditable) {
                const cells = rubricTable.querySelectorAll('td, th');
                cells.forEach(cell => {
                    if (!cell.querySelector('textarea')) {
                        cell.setAttribute('contenteditable', isEditable);
                        cell.classList.toggle('border-dashed', isEditable);
                        cell.classList.toggle('border-2', isEditable);
                        cell.classList.toggle('border-blue-300', isEditable);
                    }
                });
            }

            // --- Event Listeners ---

            // Edit button: Makes rubric text editable
            editBtn.addEventListener('click', function() {
                setTableEditable(true);
                editBtn.classList.add('hidden');
                saveChangesBtn.classList.remove('hidden');
                disableRubricInteraction();
                feedbackRows.forEach(row => row.querySelector('textarea').readOnly = false);
            });

            // Save Changes button: Locks rubric text
            saveChangesBtn.addEventListener('click', function() {
                setTableEditable(false);
                editBtn.classList.remove('hidden');
                saveChangesBtn.classList.add('hidden');
                enableRubricInteraction();
            });

            // Rating cells: Handle selection and scoring
            ratingCells.forEach(cell => {
                cell.addEventListener('click', function() {
                    if (saveChangesBtn.classList.contains('hidden')) {
                        const row = parseInt(this.dataset.row);
                        const col = parseInt(this.dataset.col);

                        document.querySelectorAll(`#criteria-row-${row} .rating-cell`).forEach(c => c.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedRatings[row] = col;

                        updateScore();
                        feedbackRows[row].classList.add('visible');
                        
                        document.getElementById(`level-description-text-${row}`).textContent = levelDescriptions[row][col];
                        document.getElementById(`level-description-row-${row}`).classList.add('visible');
                        document.getElementById(`description-row-${row}`).classList.remove('visible');
                        descriptionVisibility[row] = false;
                    }
                });
            });

            // Feedback textareas: Store input
            feedbackRows.forEach((rowElement, index) => {
                rowElement.querySelector('textarea').addEventListener('input', function() {
                    feedbackTexts[index] = this.value;
                });
            });

            // Reset button: Calls the reset function
            resetBtn.addEventListener('click', resetRubric);

            // Save Rubric button: Validates and opens the summary modal
            saveBtn.addEventListener('click', function() {
                const allCriteriaRated = selectedRatings.every((rating, i) => {
                    if (rating === null) {
                        const rowElement = document.getElementById(`criteria-row-${i}`);
                        rowElement.classList.add('highlight-missing');
                        setTimeout(() => rowElement.classList.remove('highlight-missing'), 1500);
                        return false;
                    }
                    return true;
                });

                if (!allCriteriaRated) {
                    showMessage(errorMessageElement, 'Please rate all criteria before saving.');
                    return;
                }

                // Populate and show the summary modal
                document.getElementById('modal-student-name').textContent = studentNameInput.value || 'N/A';
                document.getElementById('modal-total-score').textContent = totalScoreElement.textContent;

                const modalRatingsList = document.getElementById('modal-ratings-list');
                modalRatingsList.innerHTML = '';
                selectedRatings.forEach((rating, index) => {
                    const listItem = document.createElement('li');
                    const ratingValue = ratingLevels[index][rating];
                    const scoreValue = rating + 1;
                    const badgeClass = `rating-${scoreValue}`;
                    listItem.innerHTML = `<strong>${criteriaLabels[index]}:</strong> <span class="rating-badge ${badgeClass}">${ratingValue}</span> (Score: ${scoreValue})`;
                    modalRatingsList.appendChild(listItem);
                });

                const modalFeedback = document.getElementById('modal-feedback');
                modalFeedback.innerHTML = '';
                feedbackTexts.forEach((feedback, index) => {
                    if (feedback.trim()) {
                        const feedbackCard = document.createElement('div');
                        feedbackCard.className = 'feedback-card p-3 bg-gray-100 rounded-md mb-2';
                        feedbackCard.innerHTML = `<p class="font-semibold text-indigo-700">${criteriaLabels[index]}:</p><p>${feedback.replace(/\n/g, '<br>')}</p>`;
                        modalFeedback.appendChild(feedbackCard);
                    }
                });

                saveModal.classList.add('visible');
            });

            // Close Modal button
            closeModalBtn.addEventListener('click', () => saveModal.classList.remove('visible'));

            // **MODIFIED** Finalize button: Replaces the rubric, copies score
            finalizeBtn.addEventListener('click', function() {
                // --- Copy score to clipboard ---
                const scoreToCopy = totalScoreElement.textContent;
                const tempTextArea = document.createElement('textarea');
                // Hide the textarea from view
                tempTextArea.style.position = 'absolute';
                tempTextArea.style.left = '-9999px';
                tempTextArea.value = scoreToCopy;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                let successfulCopy = false;
                try {
                    // Execute the copy command
                    successfulCopy = document.execCommand('copy');
                } catch (err) {
                    console.error('Unable to copy score to clipboard', err);
                }
                document.body.removeChild(tempTextArea);
                // --- End of copy logic ---

                // Clone the summary content from the modal
                const modalContent = document.querySelector('.modal-content').cloneNode(true);

                // Remove the "Finalize" and "Close" buttons from the cloned content
                const buttons = modalContent.querySelector('.flex.justify-between');
                if (buttons) {
                    buttons.remove();
                }

                // Replace the entire content of the rubric container with the summary
                rubricContainer.innerHTML = modalContent.innerHTML;

                // If copy was successful, add a confirmation message to the finalized view
                if (successfulCopy) {
                    const copySuccessMessage = document.createElement('div');
                    copySuccessMessage.textContent = `Score (${scoreToCopy}) copied to clipboard!`;
                    copySuccessMessage.className = 'mt-4 p-3 bg-green-100 text-green-800 rounded-md text-center font-semibold transition-opacity duration-300';
                    rubricContainer.appendChild(copySuccessMessage);

                    // Make the message disappear after 3 seconds
                    setTimeout(() => {
                        copySuccessMessage.style.opacity = '0';
                        setTimeout(() => copySuccessMessage.remove(), 300); // Remove after fade out
                    }, 3000);
                }

                // Apply new styling to the container to fit the summary content
                rubricContainer.className = 'max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 finalized-view';
                
                // Hide the modal dialog
                saveModal.classList.remove('visible');
            });

            // Criteria names: Toggle general description visibility
            criteriaNames.forEach((criteriaNameElement, index) => {
                criteriaNameElement.addEventListener('click', function() {
                    const descriptionRow = document.getElementById(`description-row-${index}`);
                    descriptionVisibility[index] = !descriptionVisibility[index];
                    descriptionRow.classList.toggle('visible', descriptionVisibility[index]);
                    
                    if (descriptionVisibility[index]) {
                        document.getElementById(`level-description-row-${index}`).classList.remove('visible');
                    }
                });
            });

            // Initial setup on page load
            updateScore();
        });
    </script>
</body>
</html>

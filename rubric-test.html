<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Rubric</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .rubric-row:nth-child(odd) {
            background-color: rgba(243, 244, 246, 0.5);
        }
        
        .rating-cell {
            transition: all 0.2s ease;
            position: relative;
        }
        
        .rating-cell:hover {
            background-color: rgba(209, 213, 219, 0.5);
            cursor: pointer;
        }
        
        .selected {
            background-color: #4f46e5 !important;
            color: white;
            font-weight: 600;
        }
        
        .top-bar {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        
        .student-name-field {
            margin-right: 10px;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 2px solid #4f46e5;
            font-weight: 500;
            width: 200px;
        }
        
        .score-display {
            background-color: #4f46e5;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            font-weight: 600;
        }
        
        .feedback-row {
            display: none;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .feedback-row.visible {
            display: table-row;
        }
        
        .description-row {
            display: none;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .description-row.visible {
            display: table-row;
        }
        
        .level-description-row {
            display: none;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .level-description-row.visible {
            display: table-row;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal.visible {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .criteria-name {
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .criteria-name:hover {
            color: #4f46e5;
        }
        
        .criteria-name::after {
            content: "â“˜";
            font-size: 0.8rem;
            margin-left: 0.5rem;
            color: #6366f1;
        }
        
        .error-message {
            color: #dc2626;
            font-weight: 600;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: right;
        }
        
        .success-message {
            color: #10B981;
            font-weight: 600;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: right;
        }
        
        .error-message.visible, .success-message.visible {
            opacity: 1;
        }
        
        .highlight-missing {
            animation: pulse 1.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { background-color: rgba(239, 68, 68, 0); }
            50% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: rgba(239, 68, 68, 0); }
        }
        
        .finalized-view {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .rating-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }
        
        .rating-1 { background-color: #EF4444; }
        .rating-2 { background-color: #F59E0B; }
        .rating-3 { background-color: #3B82F6; }
        .rating-4 { background-color: #10B981; }
        
        .feedback-card {
            border-left: 4px solid #4f46e5;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen p-4 md:p-8">
    <div id="rubric-container" class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden relative">
        <!-- Student name and score display in top right corner -->
        <div class="top-bar">
            <input type="text" id="student-name" class="student-name-field" placeholder="Student Name" />
            <div class="score-display">
                Score: <span id="corner-score">0</span>/20
            </div>
        </div>
        
        <div class="p-6 bg-indigo-600 text-white">
            <h1 class="text-2xl font-bold">Interactive Rubric</h1>
            <p class="text-indigo-100 mt-1">Click on a cell to select a rating for each criterion</p>
        </div>
        
        <div class="p-6">
            <div class="overflow-x-auto">
                <table id="rubric-table" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-indigo-100 text-indigo-800">
                            <th class="p-4 text-left font-semibold border-b-2 border-indigo-200 w-1/4">Criteria</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 1</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 2</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 3</th>
                            <th class="p-4 text-center font-semibold border-b-2 border-indigo-200">Level 4</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Row 1: Content Knowledge -->
                        <tr class="rubric-row" id="criteria-row-0">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="0">Content Knowledge</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="0">Limited</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="1">Basic</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="2">Proficient</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="0" data-col="3">Advanced</td>
                        </tr>
                        <tr class="description-row" id="description-row-0">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Content Knowledge:</strong> Evaluates the student's understanding and mastery of subject matter. This includes accuracy of information, depth of knowledge, and ability to apply concepts appropriately.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-0">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-0"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-0">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Content Knowledge..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 2: Organization -->
                        <tr class="rubric-row" id="criteria-row-1">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="1">Organization</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="0">Disorganized</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="1">Somewhat Organized</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="2">Well Organized</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="1" data-col="3">Exceptionally Organized</td>
                        </tr>
                        <tr class="description-row" id="description-row-1">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Organization:</strong> Assesses how well the student structures information and ideas. This includes logical sequencing, clear transitions, and coherent arrangement of content to support understanding.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-1">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-1"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-1">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Organization..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 3: Communication -->
                        <tr class="rubric-row" id="criteria-row-2">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="2">Communication</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="0">Unclear</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="1">Somewhat Clear</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="2">Clear</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="2" data-col="3">Exceptionally Clear</td>
                        </tr>
                        <tr class="description-row" id="description-row-2">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Communication:</strong> Evaluates how effectively the student conveys ideas. This includes clarity of expression, appropriate language use, and the ability to articulate concepts in a way that others can understand.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-2">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-2"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-2">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Communication..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 4: Creativity -->
                        <tr class="rubric-row" id="criteria-row-3">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="3">Creativity</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="0">Minimal</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="1">Developing</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="2">Creative</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="3" data-col="3">Highly Creative</td>
                        </tr>
                        <tr class="description-row" id="description-row-3">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Creativity:</strong> Assesses the student's originality and innovative thinking. This includes novel approaches to problems, unique perspectives, and imaginative solutions that go beyond conventional thinking.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-3">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-3"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-3">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Creativity..."></textarea>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Row 5: Collaboration -->
                        <tr class="rubric-row" id="criteria-row-4">
                            <td class="p-4 font-medium border-b border-gray-200">
                                <div class="criteria-name" data-criteria="4">Collaboration</div>
                            </td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="0">Limited</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="1">Adequate</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="2">Effective</td>
                            <td class="p-4 text-center border-b border-gray-200 rating-cell" data-row="4" data-col="3">Exceptional</td>
                        </tr>
                        <tr class="description-row" id="description-row-4">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-blue-50">
                                <div class="text-sm text-blue-800">
                                    <p><strong>Collaboration:</strong> Evaluates how well the student works with others. This includes active participation in group work, respectful engagement with peers, contribution to shared goals, and ability to incorporate others' perspectives.</p>
                                </div>
                            </td>
                        </tr>
                        <tr class="level-description-row" id="level-description-row-4">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="text-sm text-indigo-800 font-medium">
                                    <p id="level-description-text-4"></p>
                                </div>
                            </td>
                        </tr>
                        <tr class="feedback-row" id="feedback-row-4">
                            <td colspan="5" class="px-4 py-3 border-b border-gray-200 bg-indigo-50">
                                <div class="flex items-center">
                                    <label class="font-medium text-indigo-700 mr-3">Feedback:</label>
                                    <textarea class="w-full p-2 border border-indigo-200 rounded-md focus:ring focus:ring-indigo-200 focus:outline-none" placeholder="Add specific feedback for Collaboration..."></textarea>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 flex justify-between items-center">
                <div class="text-gray-700">
                    <span class="font-semibold">Total Score:</span> <span id="total-score">0</span> / 20
                </div>
                <div class="flex flex-col items-end">
                    <div class="flex">
                        <!-- Edit and Save Changes buttons added here -->
                        <button id="edit-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-md text-white transition-colors mr-2">Edit</button>
                        <button id="save-changes-btn" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-md text-white transition-colors mr-2 hidden">Save Changes</button>
                        <button id="reset-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-gray-700 transition-colors mr-2">Reset</button>
                        <button id="save-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white transition-colors">Save Rubric</button>
                    </div>
                    <div id="error-message" class="error-message"></div>
                    <div id="success-message" class="success-message"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal for displaying assessment summary -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-indigo-800 mb-4">Assessment Summary</h2>
            <div class="bg-gray-50 p-4 rounded-md mb-4">
                <div class="mb-2"><strong>Student Name:</strong> <span id="modal-student-name"></span></div>
                <div class="mb-2"><strong>Total Score:</strong> <span id="modal-total-score"></span>/20</div>
                <div class="mt-4 mb-2"><strong>Individual Ratings:</strong></div>
                <ul class="list-disc pl-5 mb-4" id="modal-ratings-list"></ul>
                <div class="mt-4 mb-2"><strong>Feedback Comments:</strong></div>
                <div id="modal-feedback" class="text-sm"></div>
            </div>
            <div class="flex justify-between">
                <button id="finalize-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-md text-white transition-colors">Finalize</button>
                <button id="close-modal-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-md text-white transition-colors">Close</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ratingCells = document.querySelectorAll('.rating-cell');
            const totalScoreElement = document.getElementById('total-score');
            const cornerScoreElement = document.getElementById('corner-score');
            const resetBtn = document.getElementById('reset-btn');
            const saveBtn = document.getElementById('save-btn');
            const feedbackRows = document.querySelectorAll('.feedback-row');
            const studentNameInput = document.getElementById('student-name');
            const saveModal = document.getElementById('save-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const finalizeBtn = document.getElementById('finalize-btn');
            const criteriaNames = document.querySelectorAll('.criteria-name');
            const errorMessageElement = document.getElementById('error-message');
            const successMessageElement = document.getElementById('success-message');
            const rubricContainer = document.getElementById('rubric-container');
            const rubricTable = document.getElementById('rubric-table'); // Get the table element
            const editBtn = document.getElementById('edit-btn'); // Edit button
            const saveChangesBtn = document.getElementById('save-changes-btn'); // Save Changes button

            // Track which description rows are visible
            const descriptionVisibility = [false, false, false, false, false];

            // Criteria names for display
            const criteriaLabels = [
                "Content Knowledge",
                "Organization",
                "Communication",
                "Creativity",
                "Collaboration"
            ];

            // Rating level descriptions
            const ratingLevels = [
                ["Limited", "Basic", "Proficient", "Advanced"],
                ["Disorganized", "Somewhat Organized", "Well Organized", "Exceptionally Organized"],
                ["Unclear", "Somewhat Clear", "Clear", "Exceptionally Clear"],
                ["Minimal", "Developing", "Creative", "Highly Creative"],
                ["Limited", "Adequate", "Effective", "Exceptional"]
            ];

            // Detailed level descriptions for each criteria and level
            const levelDescriptions = [
                [
                    "Demonstrates very limited understanding of the subject matter. Information is often inaccurate or irrelevant.",
                    "Shows basic understanding of core concepts, but may have some inaccuracies or gaps in knowledge.",
                    "Demonstrates a solid understanding of the subject matter, with accurate information and appropriate application of concepts.",
                    "Exhibits deep and comprehensive understanding, connecting concepts and applying knowledge in sophisticated ways."
                ],
                [
                    "Ideas are presented randomly with no clear structure. Difficult to follow the progression of thought.",
                    "Some attempt at organization, but transitions are unclear, and the structure may be difficult to follow at times.",
                    "Ideas are logically sequenced with clear transitions, making the content easy to follow and understand.",
                    "Presents information with exceptional clarity and logical flow, enhancing the overall impact and coherence."
                ],
                [
                    "Communication is consistently unclear or difficult to understand, hindering the message.",
                    "Communication is somewhat clear, but may require effort from the audience to fully grasp the message.",
                    "Effectively conveys ideas with clarity and precision, using appropriate language and style.",
                    "Communicates with exceptional clarity, eloquence, and impact, engaging the audience effectively."
                ],
                [
                    "Lacks originality; ideas are conventional or directly copied. Shows no evidence of innovative thinking.",
                    "Shows some emerging signs of originality, but ideas are mostly conventional. Limited innovative approaches.",
                    "Demonstrates creative thinking through original ideas or unique approaches to problems.",
                    "Consistently generates highly original and innovative ideas, demonstrating exceptional creativity and imaginative solutions."
                ],
                [
                    "Struggles to work with others; may be uncooperative or disengaged in group activities.",
                    "Participates adequately in group work, but contributions may be limited or require prompting.",
                    "Works effectively with peers, contributing actively, respecting diverse perspectives, and supporting group goals.",
                    "Exemplifies outstanding collaboration, inspiring others, fostering a positive group dynamic, and achieving shared goals exceptionally well."
                ]
            ];

            // Stores the selected rating for each criterion (0-3, or null if not selected)
            const selectedRatings = Array(criteriaLabels.length).fill(null);
            // Stores the feedback text for each criterion
            const feedbackTexts = Array(criteriaLabels.length).fill('');

            // Function to calculate and update the total score
            function updateScore() {
                let totalScore = 0;
                selectedRatings.forEach(rating => {
                    if (rating !== null) {
                        totalScore += (rating + 1); // Levels are 1-4, so add 1 to 0-3 index
                    }
                });
                totalScoreElement.textContent = totalScore;
                cornerScoreElement.textContent = totalScore;
            }

            // Function to reset the rubric to its initial state
            function resetRubric() {
                selectedRatings.fill(null); // Reset all selected ratings
                feedbackTexts.fill(''); // Clear all feedback texts
                updateScore(); // Update the displayed score

                // Remove 'selected' class from all cells
                ratingCells.forEach(cell => {
                    cell.classList.remove('selected');
                });

                // Hide all feedback rows and clear textareas
                feedbackRows.forEach(row => {
                    row.classList.remove('visible');
                    row.querySelector('textarea').value = '';
                });

                // Hide all level description rows and clear their text
                document.querySelectorAll('.level-description-row').forEach(row => {
                    row.classList.remove('visible');
                    row.querySelector('p').textContent = '';
                });

                // Hide all general description rows
                document.querySelectorAll('.description-row').forEach((row, index) => {
                    row.classList.remove('visible');
                    descriptionVisibility[index] = false;
                });

                studentNameInput.value = ''; // Clear student name
                hideMessage(errorMessageElement);
                hideMessage(successMessageElement);
                rubricContainer.classList.remove('finalized-view');
                enableRubricInteraction(); // Re-enable interactions
                editBtn.classList.remove('hidden'); // Ensure Edit button is visible
                saveChangesBtn.classList.add('hidden'); // Ensure Save Changes button is hidden
                setTableEditable(false); // Lock the table text
            }

            // Function to show a message (error or success)
            function showMessage(element, message) {
                element.textContent = message;
                element.classList.add('visible');
                setTimeout(() => {
                    hideMessage(element);
                }, 5000); // Message disappears after 5 seconds
            }

            // Function to hide a message
            function hideMessage(element) {
                element.classList.remove('visible');
                element.textContent = '';
            }

            // Function to enable all rubric interactions (selection, feedback, etc.)
            function enableRubricInteraction() {
                ratingCells.forEach(cell => {
                    cell.style.pointerEvents = 'auto';
                    cell.style.cursor = 'pointer';
                });
                feedbackRows.forEach(row => {
                    row.querySelector('textarea').readOnly = false;
                });
                criteriaNames.forEach(name => {
                    name.style.pointerEvents = 'auto';
                    name.style.cursor = 'pointer';
                });
                studentNameInput.readOnly = false;
                saveBtn.disabled = false;
                resetBtn.disabled = false;
            }

            // Function to disable all rubric interactions
            function disableRubricInteraction() {
                ratingCells.forEach(cell => {
                    cell.style.pointerEvents = 'none';
                    cell.style.cursor = 'default';
                });
                feedbackRows.forEach(row => {
                    row.querySelector('textarea').readOnly = true;
                });
                criteriaNames.forEach(name => {
                    name.style.pointerEvents = 'none';
                    name.style.cursor = 'default';
                });
                studentNameInput.readOnly = true;
                saveBtn.disabled = true;
                resetBtn.disabled = true;
            }

            // Function to make table cells editable or read-only
            function setTableEditable(isEditable) {
                const cells = rubricTable.querySelectorAll('td, th'); // Select all table data and header cells
                cells.forEach(cell => {
                    // Exclude the feedback textareas as they are handled separately
                    if (!cell.querySelector('textarea')) {
                        if (isEditable) {
                            cell.setAttribute('contenteditable', 'true');
                            cell.classList.add('border-dashed', 'border-2', 'border-blue-300'); // Add visual cue for edit mode
                        } else {
                            cell.removeAttribute('contenteditable');
                            cell.classList.remove('border-dashed', 'border-2', 'border-blue-300'); // Remove visual cue
                        }
                    }
                });
            }

            // Event listener for "Edit" button
            editBtn.addEventListener('click', function() {
                setTableEditable(true); // Make table text editable
                editBtn.classList.add('hidden'); // Hide Edit button
                saveChangesBtn.classList.remove('hidden'); // Show Save Changes button
                // Optionally, disable other rubric interactions if editing text
                disableRubricInteraction();
                // Re-enable feedback textareas specifically
                feedbackRows.forEach(row => {
                    row.querySelector('textarea').readOnly = false;
                });
            });

            // Event listener for "Save Changes" button
            saveChangesBtn.addEventListener('click', function() {
                setTableEditable(false); // Lock table text
                editBtn.classList.remove('hidden'); // Show Edit button
                saveChangesBtn.classList.add('hidden'); // Hide Save Changes button
                // Re-enable all rubric interactions
                enableRubricInteraction();
            });

            // Event listeners for rating cells
            ratingCells.forEach(cell => {
                cell.addEventListener('click', function() {
                    if (saveChangesBtn.classList.contains('hidden')) { // Only allow selection if not in edit mode
                        const row = parseInt(this.dataset.row);
                        const col = parseInt(this.dataset.col);

                        // Remove 'selected' from all cells in the same row
                        document.querySelectorAll(`.rubric-row[data-row="${row}"] .rating-cell`).forEach(c => {
                            c.classList.remove('selected');
                        });

                        // Add 'selected' to the clicked cell
                        this.classList.add('selected');
                        selectedRatings[row] = col; // Store the selected rating

                        updateScore(); // Update the score

                        // Show corresponding feedback row
                        feedbackRows[row].classList.add('visible');

                        // Update level description
                        const levelDescriptionTextElement = document.getElementById(`level-description-text-${row}`);
                        levelDescriptionTextElement.textContent = levelDescriptions[row][col];
                        document.getElementById(`level-description-row-${row}`).classList.add('visible');

                        // Ensure general description is hidden when a level is selected
                        document.getElementById(`description-row-${row}`).classList.remove('visible');
                        descriptionVisibility[row] = false;
                    }
                });
            });

            // Event listeners for feedback textareas
            feedbackRows.forEach((rowElement, index) => {
                const textarea = rowElement.querySelector('textarea');
                textarea.addEventListener('input', function() {
                    feedbackTexts[index] = this.value;
                });
            });

            // Event listener for Reset button
            resetBtn.addEventListener('click', resetRubric);

            // Event listener for Save Rubric button
            saveBtn.addEventListener('click', function() {
                let allCriteriaRated = true;
                for (let i = 0; i < selectedRatings.length; i++) {
                    if (selectedRatings[i] === null) {
                        allCriteriaRated = false;
                        // Highlight the unrated row
                        document.getElementById(`criteria-row-${i}`).classList.add('highlight-missing');
                        setTimeout(() => {
                            document.getElementById(`criteria-row-${i}`).classList.remove('highlight-missing');
                        }, 1500);
                    }
                }

                if (!allCriteriaRated) {
                    showMessage(errorMessageElement, 'Please rate all criteria before saving.');
                    hideMessage(successMessageElement); // Ensure success message is hidden
                    return;
                }

                showMessage(successMessageElement, 'Rubric saved successfully!');
                hideMessage(errorMessageElement); // Ensure error message is hidden

                // Populate modal with summary
                document.getElementById('modal-student-name').textContent = studentNameInput.value || 'N/A';
                document.getElementById('modal-total-score').textContent = totalScoreElement.textContent;

                const modalRatingsList = document.getElementById('modal-ratings-list');
                modalRatingsList.innerHTML = ''; // Clear previous list
                selectedRatings.forEach((rating, index) => {
                    const listItem = document.createElement('li');
                    const ratingValue = rating !== null ? ratingLevels[index][rating] : 'Not Rated';
                    const scoreValue = rating !== null ? (rating + 1) : 0;
                    const badgeClass = rating !== null ? `rating-${rating + 1}` : '';
                    listItem.innerHTML = `<strong>${criteriaLabels[index]}:</strong> <span class="rating-badge ${badgeClass}">${ratingValue}</span> (Score: ${scoreValue})`;
                    modalRatingsList.appendChild(listItem);
                });

                const modalFeedback = document.getElementById('modal-feedback');
                modalFeedback.innerHTML = ''; // Clear previous feedback
                feedbackTexts.forEach((feedback, index) => {
                    if (feedback.trim() !== '') {
                        const feedbackCard = document.createElement('div');
                        feedbackCard.classList.add('feedback-card', 'p-3', 'bg-gray-100', 'rounded-md', 'mb-2');
                        feedbackCard.innerHTML = `<p class="font-semibold text-indigo-700">${criteriaLabels[index]}:</p><p>${feedback}</p>`;
                        modalFeedback.appendChild(feedbackCard);
                    }
                });

                saveModal.classList.add('visible'); // Show the modal
            });

            // Event listener for closing the modal
            closeModalBtn.addEventListener('click', function() {
                saveModal.classList.remove('visible');
            });

            // Event listener for Finalize button in modal
            finalizeBtn.addEventListener('click', function() {
                saveModal.classList.remove('visible');
                rubricContainer.classList.add('finalized-view');
                disableRubricInteraction(); // Disable interactions after finalizing
                showMessage(successMessageElement, 'Rubric finalized!');
            });

            // Event listeners for criteria names to toggle description rows
            criteriaNames.forEach((criteriaNameElement, index) => {
                criteriaNameElement.addEventListener('click', function() {
                    const descriptionRow = document.getElementById(`description-row-${index}`);
                    const levelDescriptionRow = document.getElementById(`level-description-row-${index}`);

                    // Toggle visibility of the general description row
                    descriptionVisibility[index] = !descriptionVisibility[index];
                    if (descriptionVisibility[index]) {
                        descriptionRow.classList.add('visible');
                    } else {
                        descriptionRow.classList.remove('visible');
                    }

                    // Hide the level description if the general description is shown
                    if (descriptionVisibility[index]) {
                        levelDescriptionRow.classList.remove('visible');
                    }
                });
            });

            // Initial setup: update score and hide messages
            updateScore();
            hideMessage(errorMessageElement);
            hideMessage(successMessageElement);
        });
    </script>
</body>
</html>
